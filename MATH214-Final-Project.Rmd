---
title: "MATH214-Final-Project"
author: 
- Ahmed A. Radhi - 100049714
- Khalid Talal Suliman - 100053835
date: "5/7/2021"
output: html_document
---

```{r}
# Loading Libraries 

library(tidyverse)
library(magrittr)
library(modelr)
library(nycflights13)
library(lubridate)
library(splines)
library(forcats)
library(plotly)

```

# Introduction and Description

The data is provided by `data.gov.uk`. It describes road accidents across `Leeds` in the year `2017`. Between all datasets, this  dataset was selected because it includes around `2,200 accident with 15 variable` that can be easily parsed and explored. Also, we selected this dataset because we believe that there are different questions that can be asked about the data, and that the data can provide interesting answers for our questions. The dataset includes data such as `location`, `date`, `time`, `road setting` and `casualty information` for each accident that transpired during the year.

**Reference :** https://data.world/datagov-uk/6efe5505-941f-45bf-b576-4c1e09b579a1


# Data Parsing and Import

```{r}
# Loading & Parsing Data

Accidents_2017 <- read_csv("Data/datagov-uk-6efe5505-941f-45bf-b576-4c1e09b579a1/2017-8.csv", 
                           col_names = c("Reference_Number","Easting","Northing","Vehicles_Num","Accident_Date","Time","Road_Class","Road_Surface",
                                         "Lightning_Cond","Weather_Cond","Vehicle_Type","Casualty_Class","Severity","Gender","Age"), skip = 1)


Accidents_Date <- Accidents_2017$Accident_Date
Accidents_Date <- parse_date(Accidents_Date, "%m/%d/%Y")

Time <- Accidents_2017$Time
Time <- parse_time(Time, "%H%M")

Accidents_2017 <- Accidents_2017 %>%
  select(1:4, 7:15) %>%
  mutate(Accidents_Date, Time) 

Accidents_2017 <- Accidents_2017[,c(1:4,14,15,5:13)]

# Correcting spelling mistakes

Lightning_Cond <- 
  str_replace(Accidents_2017$Lightning_Cond,"Darkness: Street lights present and lit and lit","Darkness: Street lights present and lit")


Road_Class <- str_replace_all(Accidents_2017$Road_Class,
      c("A.*" = "A","B.*" = "B","M.*" = "M"))


Road_Surface <- str_replace(Accidents_2017$Road_Surface,"^F.*","Snow")


Weather_Cond <- word(Accidents_2017$Weather_Cond,1) 
Weather_Cond <- str_replace(Weather_Cond,"Fog","Other")


Vehicle_Type <- word(Accidents_2017$Vehicle_Type,1)
Vehicle_Type <- str_replace_all(Vehicle_Type,
      c(".Private" = "Taxi",
        "Ca.*" = "Car","Pedal" = "Cycle"))
Vehicle_Type <- str_replace(Vehicle_Type,"TaxiTaxi", "Taxi")


# Adding the improved columns to the dataset 

Accidents_2017 <- Accidents_2017 %>% 
  select(1:6,12:15) %>%
  mutate(Lightning_Cond,Weather_Cond,Road_Class,Road_Surface,Vehicle_Type,
         Year = year(Accidents_Date),
         Month = month(Accidents_Date),
         Day = day(Accidents_Date),
         Hour = hour(Time),
         Minute = minute(Time),
         Accidents_DateTime = make_datetime(Year, Month, Day, Hour, Minute))

Accidents_2017 <- Accidents_2017[,c(1:4, 16:20, 5:6, 21, 7:15)]

# Assigning the columns to their proper classes. 

for(i in 2:length(Accidents_2017)) {
    if(is.character(Accidents_2017[[i]])) {
        Accidents_2017[[i]] <- as.factor(Accidents_2017[[i]])
    } else if (is.numeric(Accidents_2017[[i]])) {
        Accidents_2017[[i]] <- as.numeric(Accidents_2017[[i]])
    }
}

Accidents_2017

# Checking NAs 

sum(rowSums(is.na(Accidents_2017)))

# No NA values to explore
```

# Exploring Data Analysis

```{r}
EDA1 <- Accidents_2017 %>%
  group_by(Gender, Age) %>%
  summarise(Count = n() ) %>%
  ungroup() %>%
  ggplot(mapping = aes(x=Age , y = Count)) +
  geom_point(alpha = 0.6) + 
  facet_wrap(~Gender) +
  ggtitle("Number of Casualties Per Age For Males and Females") +
  ylab("Number of Casualties") +
  theme_linedraw()

layout_plot <- function(my_plot, x = -0.055, y = - 0.03){
  my_plot[['x']][['layout']][['annotations']][[1]][['y']] <- x
  my_plot[['x']][['layout']][['annotations']][[2]][['x']] <- y
  my_plot
}

ggplotly(EDA1) %>% layout_plot
```

#### The plot shows the relationship between the `Number of Casualities` and their `Age`. In addition, the plot is classified by the `Gender`, therefore; it shows how the relationship differs between males and females.

#### For females, as the age increases the count increases. The count peaks around the mid-20s, then the count declines gradually. The males' graph has a similar shape as the females'. The only difference is that the males' graph has a higher peak and the drop is sharper. 

```{r}
Accidents_2017 %>%
  group_by(Gender, Age) %>%
  summarise(Count = n() )
```




```{r}
# Distribution of Accidents across the course of the day for every day of the year

Accidents_2017 %>%
  mutate(Accidents_by_Hour = update(Accidents_DateTime, yday = 1)) %>%
  ggplot(mapping = aes(Accidents_by_Hour)) +
  geom_freqpoly(binwidth = 3600) # 5 mins interval 

# Distribution of Accidents across the course of the day for every day (and month) of the year

Accidents_2017 %>%
  mutate(Accidents_by_Hour = update(Accidents_DateTime, yday = 1),
         Accidents_by_Month = factor(Month)) %>%
  ggplot(mapping = aes(Accidents_by_Hour, color = Accidents_by_Month)) +
  geom_freqpoly(binwidth = 3600) # 1 hour interval

# Distribution of Accidents across the course of the day for every day (and month) of the year w/ y-axis as density

Accidents_2017 %>%
  mutate(Accidents_by_Hour = update(Accidents_DateTime, yday = 1),
         Accidents_by_Month = factor(Month)) %>%
  ggplot(mapping = aes(Accidents_by_Hour, color = Accidents_by_Month)) +
  geom_freqpoly(mapping = aes(y = ..density..), binwidth = 3600) # 1 hour interval

```

# Sections answering questions


```{r}
daily <- Accidents_2017 %>%
  group_by(Accidents_Date) %>%
  summarise(n = n()) %>%
  mutate(wday = wday(Accidents_Date, label = T, abbr = F))

daily

# Number of flights per day

ggplot(daily, mapping = aes(Accidents_Date, n)) +
  geom_line()

# Number of flights in each day of the week
ggplot(daily, mapping = aes(wday, n)) + 
  geom_boxplot()
  
ggplot(daily, mapping = aes(wday, n)) + 
  geom_bar(stat = "identity")

# Fitting a linear model w/ predictions & residuals

model1 <- lm(n ~ wday, data = daily)
grid <- daily %>%
  data_grid(wday) %>%
  add_predictions(model1, "n")
ggplot(daily, mapping = aes(wday, n))+
  geom_boxplot() +
  geom_point(data = grid, colour = "red", size = 4)
daily <- daily %>%
  add_residuals(model1)
ggplot(data = daily, mapping = aes(Accidents_Date, resid)) +
  geom_ref_line(h = 0) +
  geom_line()

```



#  Does the day of the week affect the time at which accidents happen ?


```{r}



# Let's started by counting the total number of accidents for each hour and visualizing it with ggplot2


accident_hour <- Accidents_2017 %>%
  count(Hour) 

accident_hour

ggplot(accident_hour,aes(Hour,n))+
  geom_line()+
  geom_point()

# Let's try to model the relationship between hours and count.

mod1 <- lm(n ~ ns(Hour,1) ,data = accident_hour)
mod2 <- lm(n ~ ns(Hour,2) ,data = accident_hour)
mod3 <- lm(n ~ ns(Hour,3) ,data = accident_hour)
mod4 <- lm(n ~ ns(Hour,4) ,data = accident_hour)
mod5 <- lm(n ~ ns(Hour,5) ,data = accident_hour)
mod6 <- lm(n ~ ns(Hour,6) ,data = accident_hour)

grid <- accident_hour %>%
  data_grid(Hour = seq_range(Hour,n = 50,expand = 0.1)) %>%
  gather_predictions(mod1,mod2,mod3,mod4,mod5,mod6,.pred = "Y")
grid

ggplot(accident_hour,aes(Hour,n))+
  geom_point()+
  geom_smooth(data = grid,aes(y = Y),colour = "red")+
  facet_wrap(~ model)

accident_hour <- accident_hour %>%
  gather_residuals(mod1,mod2,mod3,mod4,mod5,mod6)

ggplot(accident_hour,aes(Hour,resid)) +
  geom_point()+ geom_ref_line(h = 0)+ geom_smooth()+
  facet_wrap(~model)

# It seems that as we increase the degrees of freedom, the better our model gets. We will stick with 6 degrees of freedom for the rest of the analysis.


# Now we will add a day of the week variable (dow) and visualize the relationship between count and hour for each day of the week.

dow_hour <- Accidents_2017 %>%
  mutate(dow = wday(Accidents_DateTime,label =TRUE))%>%
  count(dow,Hour) 

dow_hour
  


ggplot(dow_hour,aes(Hour,n,colour = dow))+
  geom_line()+
  geom_point()

# From the graph we notice that Sunday and Saturday have a different shape from the rest of the days. Both have a low count between 6 and 9 am  compared to other days,  Saturday  peaks at an earlier time compared to other days. Moreover, Sunday has a lower count between 4 and 7 pm. The rest of the days have a similar shapes and follow the same trends. I think this is because the Sunday and Saturday are weekend days.



#Lets use a model to understand the relationship better. 

mod <- lm(n ~ ns(Hour,6) ,data = dow_hour)
mod1 <- lm(n ~ ns(Hour,6) + dow,data = dow_hour)
mod2 <- lm(n ~ ns(Hour,6) * dow,data = dow_hour)

grid <- dow_hour %>%
  data_grid(Hour = seq_range(Hour,n = 50,expand = 0.1),dow) %>%
  gather_predictions(hour_alone = mod,plus_dow = mod1,multi_dow = mod2,.pred = "Y")
grid

ggplot(dow_hour,aes(Hour,n))+
  geom_point()+
  geom_smooth(data = grid,aes(y = Y),colour = "red")+
  facet_wrap(~ model)

dow_hour <- dow_hour %>%
  gather_residuals(hour_alone = mod,plus_dow = mod1,multi_dow = mod2)

ggplot(dow_hour,aes(Hour,resid)) +
  geom_point()+ geom_ref_line(h = 0)+ geom_smooth()+
  facet_wrap(~model)

# It looks like mod2 (Hour * day of the week) gives us the plot with the best residuals. Only 5 points from 168 points are outside a distance of 10 residuals.


dow_hour %>%
  filter(model == "multi_dow") %>%
ggplot(aes(Hour,resid,colour = dow))+
   geom_ref_line(h = 0) + 
  geom_point()



```